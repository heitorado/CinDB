<!DOCTYPE html>
<html lang="en">
<head>
      <title>CinDB</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <script src="../public/js/jquery.min.js"></script>
      <link rel="stylesheet" href="../public/css/bootstrap.min.css">
      <!-- Custom styles for this template -->
      <link href="../public/css/style.css" rel="stylesheet">
</head>
<body>
      <nav id="indexNav" class="navbar navbar-inverse">
            <div class="container-fluid">
                  <div class="navbar-header">
                        <a class="navbar-brand"> CinDb </a>
                  </div>
            </div>
      </nav>

      <div class="container-fluid text-center">
            <div class="wrapper row">
                  <!-- Barra lateral esquerda -->
                  <div id="indexSidebar" class="col-sm-12 col-md-2 sidebar">
                        <div class="dropdown">
                              <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
                                    Selecione...
                                    <span class="caret"></span>
                              </button>
                              <!-- left para ajustar a posição -->
                              <ul id="cadeiras" class="dropdown-menu dropdown-menu-left">

                              </ul>
                        </div>

                        <div class="search">
                              <p>Filtros:</p>
                        </div>
                        <div class="tags" id="tags"></div>
                  </div>

                  <!-- Conteudo -->
                  <div id="indexContent" class="col-sm-12 col-md-10 text-center" style="margin: 10px auto;">
                        <div id="exercicios">
                              <div class="welcome-message">
                                    <h1>Bem Vindo!</h1>
                                    <p>Para ver os exercícios disponíveis, escolha uma cadeira dentre as disponíveis na lista ao lado :)</p>
                              </div>
                        </div>
                        <div id="pagination"></div>
                  </div>

            </div>
            <!-- Fim Conteudo -->
      </div>

      <footer class="container-fluid text-center">
            <p>fecit anno MMXVII</p>
      </footer>

      <script type="text/javascript" src="../public/js/jquery.twbsPagination.min.js"></script>
      <script>
      // PEGAR CADEIRAS
      $.ajax({
            type : "POST",
            data:{buscarCadeiras : 1},
            url : "../Core/ExerciciosIndexControle.php",
            success: function (response) {
                  cadeiras = $.parseJSON(response);

                  $(cadeiras).each(function(e){
                        var li = $(document.createElement('li'));
                        var a = $(document.createElement('a'))
                        .attr('id', 'idCadeira-'+this.idcadeiras)
                        .attr('href', '#');
                        a.append(this.nome);
                        li.append(a);

                        $("ul#cadeiras").append(li);
                  });
            }
      });
      var cadeiraId;
      $(document).on('click','a[id^="idCadeira"]',function(){
            $('#pagination').empty();
            cadeiraId = $(this).attr('id').split('-')[1];
            carregarTags(cadeiraId);
            carregarExercicio(cadeiraId, null);
      });

      $(document).on('click','input[id^="tags"]',function(){
            $('#pagination').empty();
            var tagId = "";

            $('input[id^="tags"]').each(function ()
            {
                  if ($(this).is(':checked')) {
                        tagId += $(this).attr('value') + ',';
                  }
            });
            tagId = tagId.substring(0, tagId.length-1);

            carregarExercicio(cadeiraId, tagId);
      });


      function carregarExercicio(cadeiraId, tagId) {
            $.ajax({
                  type : "POST",
                  data:{idCadeira : cadeiraId,
                        idTag : tagId},
                  url : "../Core/ExerciciosIndexControle.php",
                  success: function (response) {
                        $("#exercicios").empty();
                        exercicios = $.parseJSON(response);
                        console.log(exercicios);
                        if(exercicios.length > 0){
                              exibirExercicios(exercicios, exercicios.length);
                        } else{
                              exibirNenhumExercicio();
                        }
                  }
            });
      }

      function carregarTags(cadeiraId) {
            $.ajax({
                  type : "POST",
                  data:{idCadeiraTag : cadeiraId},
                  url : "../Core/ExerciciosIndexControle.php",
                  success: function (response) {
                        $("#tags").empty();
                        tags = $.parseJSON(response);
                        if(tags.length > 0){
                              exibirTags(tags);
                        } else{
                              exibirNenhumaTag();
                        }
                  }
            });
      }

      function exibirTags(tags) {
            for (var i = 0; i < tags.length; i++) {
                  var label = $(document.createElement('label'));
                  var input = $(document.createElement('input'))
                  .attr('type', 'checkbox')
                  .attr('value', tags[i].idtags)
                  .attr('id', 'tags-' + tags[i].idtags);

                  label.append(input);
                  label.append(tags[i].nome);
                  $('#tags').append(label, '<br>');
            }
      }

      function exibirNenhumaTag() {
            var div = $(document.createElement('div')).attr('class', 'welcome-message');
            var h2 = $(document.createElement('h3')).append("Sem resultado!");
            var p = $(document.createElement('p')).append("Nenhuma tag relacionada");
            $("#tags").append(div.append(h2,p));
      }

      function exibirNenhumExercicio() {
            var div = $(document.createElement('div')).attr('class', 'welcome-message');
            var h2 = $(document.createElement('h2')).append("Sem resultado!");
            var p = $(document.createElement('p')).append("Nenhum exercicios encontrado");
            $("#exercicios").append(div.append(h2,p));
      }

      function exibirExercicios(exercicios, cardLength){

            var pags = [];
            var numPages = Math.ceil(cardLength / 6);

            var pagination = $(document.createElement('ul')).attr( 'class', 'pagination');
            pagination.twbsPagination({
                  totalPages : numPages,
                  first : "Primeiro",
                  prev : '<span aria-hidden="true">&laquo;</span>',
                  next : '<span aria-hidden="true">&raquo;</span>',
                  last : "Último",
                  visiblePages : 4,
                  onPageClick : function(evt, page){
                        geraCards(page, exercicios, cardLength);
                  }
            });

            $("#pagination").append(pagination);
      }

      function geraCards(page, exercicios, cardLength){
            $('#exercicios').empty();
            var inicio = (page-1) * 6;
            var cards = carregaCards(exercicios, cardLength);

            for (var i = 0; i < 6; i++) {
                  $('#exercicios').append(cards[inicio+i]);
            }
      }

      function carregaCards(exercicios, cardLength){
            var cards = [];

            for(var i = 0; i < cardLength; i++)
            {
                  var texto = exercicios[i].enunciado;
                  var topicoTexto = exercicios[i].tags != "" ? "Topicos: " + exercicios[i].tags + "<br>" : "";
                  topicoTexto += "Cadeira: " + exercicios[i].cadeira + "<br>"
                  + "Professor: " + exercicios[i].professor

                  var card = $(document.createElement('div')).attr( 'class', 'exercise-card' )
                  .attr( 'id', 'exercicio-' + exercicios[i].idexercicio );
                  var img = $(document.createElement('img')).attr('src',exercicios[i].image)
                  .attr('alt',exercicios[i].image)
                  .attr('title',exercicios[i].image);

                  var container = $(document.createElement('div')).attr('class', 'card-container');
                  var topico = $(document.createElement('h4')).append(topicoTexto);
                  var enun = $(document.createElement('p'))
                  .append(texto.substring(0, 145) + '...');

                  container.append(topico, enun);
                  card.append(img,container);
                  cards.push(card);
            }
            return cards;
      }
      </script>

      <script src="../public/js/bootstrap.min.js"></script>
</body>
</html>
